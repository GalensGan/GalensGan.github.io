---
layout: post
category: 软件
title: Windows Terminal 终端增强和美化
tagline: by 明不知昔
tags: 
  - WindowsTerminal
published: true
---

![常规展示](https://pic2.zhimg.com/80/v2-59db8c16ee82335a0f6229b1f01f5481_720w.jpg)

Windows 上的终端难用又难看，直到我遇到了 Windows Terminal 和 Powershell 7。那丝滑般的操作手感，美得不可方物的界面，还有其强大的功能支持，瞬间坠入爱河，爱了爱了~

<!--more-->

下面我们就一步一步开始安装和配置。



## 安装 Windows Terminal

相信这一步对大多数人不构成任何困难，直接去 **Microsoft Store** 搜索下载就是了。

> 该项难度系数：0

## 安装字体

这里仅推荐一款字体：**Fira Code**。该字体支持 ligature 连字功能，而且是一款专门为代码显示准备的字体。该字体开源，广受海内外程序员好评！

[单击此处从 GitHub 下载](https://link.zhihu.com/?target=https%3A//github.com/tonsky/FiraCode/releases/download/3.1/FiraCode_3.1.zip)

装上该字体，即可进入下一步。

> 该项难度系数：1
>
> 难点在于或许有人登 Github 有网络问题，请自行解决。



## 安装新款 Powershell Core

首先声明，我们这儿用的 Powershell 与 Windows 自带的 Powershell 是完全不同的两个东西，除了功能相似和名字相同，两者内在已经天差地别。

自带的 Powershell **错误提示冗长**，**颜值低**，**速度慢**，总之就是不值得去用。

那么 Powershell Core 是什么呢？这是伟大的 **.Net Core 跨平台战略**的一个重要组成部分，微软设想，要让强大的 .Net 在所有平台上通用，让这么强大的 Powershell 在所有平台上都能用，古老的 bash 可以退休了！

基于以上愿景，微软开始了漫长而辉煌的征程。

开源，还是开源。在 [https://github.com/PowerShell/PowerShell/releases](https://link.zhihu.com/?target=https%3A//github.com/PowerShell/PowerShell/releases) 这个GitHub 链接里，有目前 Powershell 的最新版，我建议你从 release 里选个最新的 preview 版本。**经过测试，这些预览版都相当稳定。**

[直接单击此处下载 x86-64 Windows 64 位 .msi 安装包。](https://link.zhihu.com/?target=https%3A//github.com/PowerShell/PowerShell/releases/download/v7.1.0-preview.2/PowerShell-7.1.0-preview.2-win-x64.msi)

安装过程中会提示安装选项，全部勾选就可以了。

![安装界面](https://i.loli.net/2021/06/05/WCQI3UnNl4LDbOo.png)

上面的各个选项分别是：

- [ ] 添加 PowerShell 到环境变量
- [ ] 注册到 Windows 事件
- [ ] 允许 PowerShell 远程
- [ ] 在文件管理器中右键菜单
- [ ] 给 PowerShell 文件添加用 PowerShell 7-preview 右键菜单

> 该项难度系数：1
>
> 难度来自于访问 Github。

## 安装 Powershell 插件

这一步是整个过程的灵魂。

直接上代码：打开刚装好的新版 powershell，逐行输入命令。

```powershell
# 1. 安装 PSReadline 包，该插件可以让命令行很好用，类似 zsh
Install-Module -Name PSReadLine -AllowPrerelease -Force

# 2. 安装 posh-git 包，让你的 git 更好用
Install-Module posh-git -Scope CurrentUser

# 3. 安装 oh-my-posh 包，让你的命令行更酷炫、优雅
Install-Module oh-my-posh -Scope CurrentUser

# 4。安装 ZLocation，可以通过 z xx(xx是路径的关键词) 快速定位路径
Install-Module ZLocation -Scope CurrentUser
```

安装过程可能有点慢，**好像卡住了一样**，但是请耐心等待几分钟。另外，可能需要挂代理才能下载、安装。这几个包的都不大，所以如果迟迟装不上，就基本上是网络问题。

> 该项难度系数：0

后面两个包的**来源可能不受系统信任**，不用管它，如果让你选择是否信任，直接输入 `Y` 即可。

## 配置 Windows Terminal

这一项也是灵魂。

只有新款 Powershell 而没有 Windows Terminal，好比吃肉不放盐。

打开Windows Terminal，然后按快捷键 `Ctrl+Shift+,` 打开配置文件，直接上配置代码，遇到不懂的地方，自己读注释。记得将此设置默认配置（代码已经给出）。

``` json
// This file was initially generated by Windows Terminal Preview 1.4.2652.0
// It should still be usable in newer versions, but newer versions might have additional
// settings, help text, or changes that you will not see unless you clear this file
// and let us generate a new one for you.

// To view the default settings, hold "alt" while clicking on the "Settings" button.
// For documentation on these settings, see: https://aka.ms/terminal-documentation
{
    "$schema": "https://aka.ms/terminal-profiles-schema",

    // 默认的配置就是我们的新 powershell（重要！！！）
    // 认准这个Id: "{574e775e-4f2a-5b96-ac1e-a2962a402336}"
    "defaultProfile": "{574e775e-4f2a-5b96-ac1e-a2962a402336}",

    // You can add more global application settings here.
    // To learn more about global settings, visit https://aka.ms/terminal-global-settings

    // If enabled, selections are automatically copied to your clipboard.
    "copyOnSelect": false,

    // If enabled, formatted data is also copied to your clipboard
    "copyFormatting": false,

    // A profile specifies a command to execute paired with information about how it should look and feel.
    // Each one of them will appear in the 'New Tab' dropdown,
    //   and can be invoked from the commandline with `wt.exe -p xxx`
    // To learn more about profiles, visit https://aka.ms/terminal-profile-settings
    "profiles":
    {		
        "defaults":
        {
            // Put settings here that you want to apply to all profiles.
			"startingDirectory" : ".",
			"useAcrylic": true
        },
        "list":
        [
            {
                // Make changes here to the powershell.exe profile.
                "guid": "{61c54bbd-c2c6-5271-96e7-009a87ff44bf}",
                "name": "Windows PowerShell",
                "commandline": "powershell.exe",
                "hidden": true // 隐藏原来的 PowerShell
            },
            {
                // Make changes here to the cmd.exe profile.
                "guid": "{0caa0dad-35be-5f56-a8ff-afceeeaa6101}",
                "name": "命令提示符",
                "commandline": "cmd.exe",
                "hidden": true // 隐藏 cmd
            },
            {
                "guid": "{b453ae62-4e3d-5e58-b989-0a998ec441b8}",
                "hidden": true, // 隐藏 Azure Cloud Shell
                "name": "Azure Cloud Shell",
                "source": "Windows.Terminal.Azure"
            },
            {
                "guid": "{574e775e-4f2a-5b96-ac1e-a2962a402336}",
                "hidden": false,
                "name": "PowerShell",             
				// 注意：一定要写上 -nologo，否则开启 powershll 会有一段话输出，很讨厌！
                // 路径自己去核实，如果是正式版本，就是 .../7/pwsh.exe
				"commandline": "C:/Program Files/PowerShell/7-preview/pwsh.exe -nologo", 
				"source": "Windows.Terminal.PowershellCore",
				// 启动菜单一定要设置为 <.>，否则后面重要的一步将会无效！
				"startingDirectory": ".",
				// 字体
				"fontFace": "Fira Code",
				"fontSize": 11,
				"historySize": 9001,
				"padding": "5, 5, 20, 25",
				"snapOnInput": true,
				"useAcrylic": false,
				// 颜色
				"colorScheme": "Homebrew"
            }
        ]
    },

    // Add custom color schemes to this array.
    // To learn more about color schemes, visit https://aka.ms/terminal-color-schemes
    "schemes": [
        // Homebrew 配色，该配色经过 刘鹏 改良
		{
			"name": "Homebrew",
			"black": "#000000",
			"red": "#FC5275",
			"green": "#00a600",
			"yellow": "#999900",
			"blue": "#6666e9",
			"purple": "#b200b2",
			"cyan": "#00a6b2",
			"white": "#bfbfbf",
			"brightBlack": "#666666",
			"brightRed": "#e50000",
			"brightGreen": "#00d900",
			"brightYellow": "#e5e500",
			"brightBlue": "#0000ff",
			"brightPurple": "#e500e5",
			"brightCyan": "#00e5e5",
			"brightWhite": "#e5e5e5",
			"background": "#283033",
			"foreground": "#00ff00"
		},
	],

    // Add custom actions and keybindings to this array.
    // To unbind a key combination from your defaults.json, set the command to "unbound".
    // To learn more about actions and keybindings, visit https://aka.ms/terminal-keybindings
    "actions":
    [
        // Copy and paste are bound to Ctrl+Shift+C and Ctrl+Shift+V in your defaults.json.
        // These two lines additionally bind them to Ctrl+C and Ctrl+V.
        // To learn more about selection, visit https://aka.ms/terminal-selection
        { "command": {"action": "copy", "singleLine": false }, "keys": "ctrl+c" },
        { "command": "paste", "keys": "ctrl+v" },

        // Press Ctrl+Shift+F to open the search box
        { "command": "find", "keys": "ctrl+shift+f" },

        // Press Alt+Shift+D to open a new pane.
        // - "split": "auto" makes this pane open in the direction that provides the most surface area.
        // - "splitMode": "duplicate" makes the new pane use the focused pane's profile.
        // To learn more about panes, visit https://aka.ms/terminal-panes
        { "command": { "action": "splitPane", "split": "auto", "splitMode": "duplicate" }, "keys": "alt+shift+d" }
    ]
}
```

特别注意，用其他配色可能**降低颜值**。

> 该项难度系数：0
>
> 难点在于：需要懂点 json，还**需要会配置 Windows Terminal**。

## 添加 Powershell 启动参数

在 powershell 中输入

```powershell
notepad.exe $Profile
```

紧接着在弹出的页面中输入下面这一长串代码，保存并关闭。这个 Profile 配置文件与 .zshrc / .bashrc 文件一样，都是控制启动前参数的。

``` json
<#
 * FileName: Microsoft.PowerShell_profile.ps1
 * Author: 刘 鹏
 * Email: littleNewton6@outlook.com
 * Date: 2020, May. 1
 * Copyright: No copyright. You can use this code for anything with no warranty.
#>


#------------------------------- Import Modules BEGIN -------------------------------
# 引入 posh-git
Import-Module posh-git

# 引入 oh-my-posh
Import-Module oh-my-posh

# 设置 PowerShell 主题
Set-PoshPrompt -Theme Paradox
#------------------------------- Import Modules END   -------------------------------





#-------------------------------  Set Hot-keys BEGIN  -------------------------------
# 设置 Tab 键补全
# Set-PSReadlineKeyHandler -Key Tab -Function Complete

# 设置 Ctrl+d 为菜单补全和 Intellisense
Set-PSReadLineKeyHandler -Key "Tab" -Function MenuComplete

# 设置 Ctrl+d 为退出 PowerShell
Set-PSReadlineKeyHandler -Key "Ctrl+d" -Function ViExit

# 设置 Ctrl+z 为撤销
Set-PSReadLineKeyHandler -Key "Ctrl+z" -Function Undo

# 设置向上键为后向搜索历史记录
Set-PSReadLineKeyHandler -Key UpArrow -Function HistorySearchBackward

# 设置向下键为前向搜索历史纪录
Set-PSReadLineKeyHandler -Key DownArrow -Function HistorySearchForward
#-------------------------------  Set Hot-keys END    -------------------------------



#-------------------------------  引用与上述冲突的模块 BEGIN    -------------------------------

# 引用模块 ZLocation，必须放到上面模块设置完成后的位置，否则会不生效
Import-Module ZLocation

#-------------------------------    Functions BEGIN   -------------------------------




#-------------------------------    Functions BEGIN   -------------------------------
# Python 直接执行
$env:PATHEXT += ";.py"

# 更新 pip 的方法
function Update-Packages {
    # update pip
    Write-Host "Step 1: 更新 pip" -ForegroundColor Magenta -BackgroundColor Cyan
    $a = pip list --outdated
    $num_package = $a.Length - 2
    for ($i = 0; $i -lt $num_package; $i++) {
        $tmp = ($a[2 + $i].Split(" "))[0]
        pip install -U $tmp
    }

    # update TeX Live
    $CurrentYear = Get-Date -Format yyyy
    Write-Host "Step 2: 更新 TeX Live" $CurrentYear -ForegroundColor Magenta -BackgroundColor Cyan
    tlmgr update --self
    tlmgr update --all
}
#-------------------------------    Functions END     -------------------------------





#-------------------------------   Set Alias Begin    -------------------------------
# 1. 编译函数 make
function MakeThings {
    nmake.exe $args -nologo
}
Set-Alias -Name make -Value MakeThings

# 2. 更新系统 os-update
Set-Alias -Name os-update -Value Update-Packages

# 3. 查看目录 ls & ll
function ListDirectory {
    (Get-ChildItem).Name
    Write-Host("")
}
Set-Alias -Name ls -Value ListDirectory
Set-Alias -Name ll -Value Get-ChildItem
#-------------------------------    Set Alias END     -------------------------------
```

到此，配置完成！在命令行里面狂欢吧。



## 参考

[1]  [原文链接：Windows Terminal 完美配置 PowerShell 7.1](https://zhuanlan.zhihu.com/p/137595941)

[2] [awesome-powershell](https://github.com/janikvonrotz/awesome-powershell)

[3] [posh-git](https://github.com/dahlbyk/posh-git)

[4] [PSReadLine](https://github.com/PowerShell/PSReadLine)

[5] [ZLocation](https://github.com/vors/ZLocation)

[6] [oh-my-posh](https://github.com/jandedobbeleer/oh-my-posh)

